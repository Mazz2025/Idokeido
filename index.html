<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>住所から緯度経度、最寄り駅を取得</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse CDN for CSV parsing (used for city codes data) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content display */
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 900px;
            width: 100%;
        }
        .btn {
            @apply px-6 py-3 rounded-lg text-white font-semibold transition-all duration-300 ease-in-out;
            @apply shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-opacity-75;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-success {
            @apply bg-green-600 hover:bg-green-700 focus:ring-green-500;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 focus:ring-gray-400;
        }
        .btn-disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
        input[type="file"] {
            @apply block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none;
        }
        input[type="text"], select {
            @apply block w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500;
        }
        .message-box {
            @apply p-4 mt-4 rounded-lg;
        }
        .message-info {
            @apply bg-blue-100 text-blue-800;
        }
        .message-success {
            @apply bg-green-100 text-green-800;
        }
        .message-error {
            @apply bg-red-100 text-red-800;
        }
        .message-warning {
            @apply bg-yellow-100 text-yellow-800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">住所から緯度経度、最寄り駅を取得</h1>

        <div class="mb-6 bg-blue-50 p-4 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">はじめに</h2>
            <p class="text-gray-700 mb-2">
                このツールは、CSVファイル内の住所情報から緯度、経度、**最寄り駅とその距離**を取得し、新しいCSVファイルとして出力します。
            </p>
            <p class="text-gray-700 font-medium">
                <span class="text-red-600 font-bold">重要:</span> Google スプレッドシートをご利用の場合、「ファイル」>「ダウンロード」>「カンマ区切り形式（.csv）」でCSVファイルをダウンロードしてからアップロードしてください。
            </p>
            <p class="text-gray-700 text-sm mt-3">
                <span class="font-bold">【APIと駅データについて】</span><br>
                本ツールは、緯度経度の取得には国土地理院のAPIを利用します。<br>
                最寄り駅の検索には、お客様がGitHubにアップロードした**GeoJSON形式の駅マスターデータ**を使用します。<br>
                住所が「1-2-3」のように入力されている場合、API呼び出し前に「1丁目2番3号」のように**自動的に変換**して取得を試みます。<br>
                データが見つからない場合やAPIエラーの場合は「不明」または空欄と表示されます。<br>
                実行後、ブラウザのF12キーで開発者ツールを開き、[Console]タブをご確認ください。APIレスポンスや駅データ検索の詳細なログが表示されます。
            </p>
            <p class="text-red-600 text-sm mt-2 font-bold">
                注: 駅データのURLは、このHTMLコード内の `stationsDataUrl` 変数を、お客様がGitHubにアップロードしたGeoJSONファイルのRaw URLに置き換える必要があります。国土数値情報からダウンロードしたGeoJSONファイルを直接利用できますが、データ量が多い場合、読み込みに時間がかかることがあります。
            </p>
            <p class="text-red-600 text-sm mt-2 font-bold">
                **★重要: 市区町村コードデータのURLを貼り付けてください★**<br>
                このHTMLコード内の `cityCodesDataUrl` 変数を、お客様がGitHubにアップロードした`city-codes.csv`ファイルのRaw URLに置き換える必要があります。
                現在の値は `YOUR_RAW_CITY_CODES_CSV_URL_HERE` です。
            </p>
        </div>

        <div class="mb-4">
            <label for="csvFile" class="block text-gray-700 text-sm font-bold mb-2">CSVファイルをアップロード:</label>
            <input type="file" id="csvFile" accept=".csv" class="mb-4">
            <button id="clearFileButton" class="btn btn-secondary text-sm px-4 py-2 mt-2">ファイルの選択をクリア</button>
        </div>

        <div class="mb-4">
            <label for="encodingSelect" class="block text-gray-700 text-sm font-bold mb-2">文字コード:</label>
            <select id="encodingSelect" class="mb-4">
                <option value="UTF-8">UTF-8 (推奨)</option>
                <option value="Shift_JIS">Shift-JIS</option>
            </select>
        </div>

        <div id="headerDisplay" class="mb-4 p-3 bg-gray-100 rounded-lg hidden">
            <p class="text-gray-700 text-sm font-bold mb-2">認識されたヘッダー:</p>
            <code id="parsedHeaders" class="block bg-gray-200 p-2 rounded-md text-sm text-gray-800 break-all"></code>
        </div>

        <div class="mb-6">
            <label for="addressColumn" class="block text-gray-700 text-sm font-bold mb-2">住所の列名（例: 住所, Address）:</label>
            <input type="text" id="addressColumn" placeholder="例: 住所" class="mb-4">
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <button id="geocodeButton" class="btn btn-primary flex-1" disabled>緯度経度と最寄り駅を取得</button>
            <button id="cancelButton" class="btn btn-danger flex-1 hidden" disabled>キャンセル</button>
            <button id="downloadCsvButton" class="btn btn-success flex-1" disabled>CSVをダウンロード</button>
        </div>

        <!-- Excelでのゼロ欠落に関する注意書き -->
        <div id="excelWarning" class="message-box message-warning text-sm mt-2">
            <p class="font-bold">【ダウンロードファイルを開く際の注意】</p>
            <p>ダウンロードしたCSVファイルをExcelで直接開くと、郵便番号や市区町村コードなどの先頭の「0」が消える場合があります。</p>
            <p>これはExcelの自動変換によるものです。ゼロを保持するには、以下のいずれかの方法で開いてください:</p>
            <ul class="list-disc list-inside ml-4 mt-1">
                <li>メモ帳やテキストエディタで開く。</li>
                <li>Excelの「データ」タブ → 「データを取り込み」 → 「テキストまたはCSVから」を選択し、インポートウィザードで列のデータ形式を「テキスト」に指定して取り込む。</li>
            </ul>
        </div>
        
        <div id="messageBox" class="message-box message-info hidden">
            <p id="messageText"></p>
        </div>

        <div id="progressBarContainer" class="w-full bg-gray-200 rounded-full h-4 mt-6 hidden">
            <div id="progressBar" class="bg-blue-600 h-4 rounded-full text-xs text-white flex items-center justify-center" style="width: 0%">
                <span id="progressText">0%</span>
            </div>
        </div>
    </div>

    <script>
        // DOM要素の取得
        const csvFileInput = document.getElementById('csvFile');
        const clearFileButton = document.getElementById('clearFileButton');
        const encodingSelect = document.getElementById('encodingSelect');
        const addressColumnInput = document.getElementById('addressColumn');
        const geocodeButton = document.getElementById('geocodeButton');
        const cancelButton = document.getElementById('cancelButton'); // キャンセルボタンを追加
        const downloadCsvButton = document.getElementById('downloadCsvButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const headerDisplay = document.getElementById('headerDisplay');
        const parsedHeadersText = document.getElementById('parsedHeaders');

        let parsedData = []; // パースされたCSVデータを保持
        let headers = [];    // CSVヘッダーを保持
        let resultData = []; // 緯度経度と最寄り駅を追加した結果データを保持
        let stationsData = []; // 駅マスターデータを保持
        let cityCodesData = []; // 市区町村コードマスターデータを保持
        let isProcessingCancelled = false; // 処理中断フラグ

        // --- 駅データのURLを指定 (ここをあなたのRaw URLに置き換える必要があります！) ---
        // 例: 'https://raw.githubusercontent.com/your-username/your-repo/main/N02-20_Station.geojson'
        // GitHubにアップロードした N02-20_Station.geojson の「Raw」ボタン（または三点リーダーメニューの「Raw file content」をクリックして開いた新しいタブのURL）を正確に貼り付けてください。
        const stationsDataUrl = 'https://raw.githubusercontent.com/Mazz2025/Idokeido/main/N02-20_Station.geojson'; 

        // --- 市区町村コードデータのURLを指定 (ここをあなたのRaw URLに置き換える必要があります！) ---
        // 例: 'https://raw.githubusercontent.com/your-username/your-repo/main/city-codes.csv'
        const cityCodesDataUrl = 'https://raw.githubusercontent.com/Mazz2025/Idokeido/refs/heads/main/city-codes.csv'; // ★ここを city-codes.csv のRaw URLに置き換えてください

        // --- 出力CSVファイルの最終的なヘッダー順とマッピング ---
        const OUTPUT_HEADERS = [
            '企業コード', '店舗コード', 'ロケール', '店舗名(漢字)', '店舗名(カナ)', '請求先コード1',
            '請求先コード2', '使用不可フラグ', '郵便番号', 'L2コード', '市区町村コード',
            '国交省住所1', 
            '国交省住所2', '国交省住所補足', '住所1', '住所2', '住所3', '電話番号', 'FAX番号',
            '担当部門', '担当者役職', '担当者名', '担当者MAIL', '代表業態コード', '業態中分類コード',
            '旧業態コード', '旧業態コード中分類', '顧客側店舗コード', '管轄DOコード', '緯度', '経度',
            '鉄道最寄駅', 
            'バス最寄駅', '添付ファイルコード', 'ファイル名', 'ファイルアップロード日',
            'SEJDO名', '免許品', '実績年月日1', '実績作業量1', '実績年月日2', '実績作業量2',
            '実績年月日3', '実績作業量3', '登録日時', '登録ユーザID', '更新日時', '更新ユーザID'
        ];

        // --- 入力CSVと出力CSVのマッピング (特定の変換が必要なもののみ) ---
        // key: 出力ヘッダー名, value: 入力CSVのヘッダー名または特殊な処理
        const INPUT_TO_OUTPUT_MAPPING = {
            '企業名': 'クライアント名', 
            '店舗名(漢字)': '店舗名',
            '店舗名(カナ)': 'フリガナ', 
            '郵便番号': '郵便番号', // This will be overwritten by extracted postal code
            '国交省住所1': '住所', // GSI APIのproperties.titleから取得
            '顧客側店舗コード': '顧客店番'
        };


        // アプリ起動時にマスターデータ（駅データ、市区町村コードデータ）を読み込む
        window.onload = async () => {
            let stationsDataLoaded = false;
            let cityCodesDataLoaded = false;

            // 駅データ読み込み
            if (!stationsDataUrl.startsWith('http')) {
                showMessage('警告: 駅データのURLが設定されていません。最寄り駅検索機能は利用できません。', 'error');
            } else {
                await loadStationsData();
                if (stationsData.length > 0) stationsDataLoaded = true;
            }

            // 市区町村コードデータ読み込み
            if (!cityCodesDataUrl.startsWith('http') || cityCodesDataUrl === 'YOUR_RAW_CITY_CODES_CSV_URL_HERE') { // ★変更点: プレースホルダーのチェックを追加
                showMessage('警告: 市区町村コードデータのURLが設定されていません。市区町村コードの取得機能は利用できません。コード内の `cityCodesDataUrl` 変数を正しいURLに置き換えてください。', 'error');
            } else {
                await loadCityCodesData();
                if (cityCodesData.length > 0) cityCodesDataLoaded = true;
            }
            
            // 全ての必須データが読み込まれたらボタンを有効化
            if (stationsDataLoaded || cityCodesDataLoaded) { // どちらか片方でもロードされていればCSVアップロードは可能
                showMessage('アプリが起動しました。CSVファイルをアップロードしてください。');
                csvFileInput.disabled = false;
                geocodeButton.disabled = false; // 処理開始ボタンを有効化
            } else {
                showMessage('必要なデータ（駅または市区町村コード）を読み込めませんでした。CSVのアップロードと処理はできません。', 'error');
                csvFileInput.disabled = true;
                geocodeButton.disabled = true;
            }
            
            cancelButton.classList.add('hidden'); // 初期状態ではキャンセルボタンは非表示
            downloadCsvButton.disabled = true; // 初期状態ではダウンロードボタンは無効
        };

        // メッセージ表示関数
        function showMessage(text, type = 'info') {
            messageBox.classList.remove('hidden', 'message-info', 'message-success', 'message-error', 'message-warning'); // 全てのタイプをリセット
            messageBox.classList.add('p-4', 'mt-4', 'rounded-lg'); // スタイルを再適用
            messageText.textContent = text;
            if (type === 'info') {
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'warning') {
                messageBox.classList.add('bg-yellow-100', 'text-yellow-800');
            }
            messageBox.classList.remove('hidden'); // メッセージボックスを表示
        }

        // プログレスバー表示関数
        function updateProgressBar(progress) {
            progressBarContainer.classList.remove('hidden');
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
        }

        // CSVファイル読み込みイベントリスナー
        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                // ファイル選択がキャンセルされた場合、現在の状態を維持
                return;
            }

            const reader = new FileReader();
            const encoding = encodingSelect.value; // 選択された文字コードを取得

            reader.onload = (e) => {
                const text = e.target.result;
                try {
                    parseCsv(text);
                    showMessage('CSVファイルが読み込まれました。');
                    // 駅データまたは市区町村コードデータが読み込まれていればボタンを有効に
                    if (stationsData.length > 0 || cityCodesData.length > 0) {
                         geocodeButton.disabled = false;
                    } else {
                         showMessage('必要なデータ（駅または市区町村コード）が読み込まれていないため、処理できません。', 'warning');
                         geocodeButton.disabled = true;
                    }
                    downloadCsvButton.disabled = true; // 新しいファイルを読み込んだらダウンロードボタンを無効化
                    progressBarContainer.classList.add('hidden'); // プログレスバーをリセット
                    headerDisplay.classList.remove('hidden'); // ヘッダー表示を常に表示
                } catch (error) {
                    showMessage('CSVのパース中にエラーが発生しました。ファイル形式または文字コードが正しくない可能性があります。', 'error');
                    console.error("CSV parsing error:", error);
                    geocodeButton.disabled = true;
                    headerDisplay.classList.add('hidden'); // エラー時はヘッダー表示を隠す
                }
            };
            reader.onerror = () => {
                showMessage('ファイルの読み込み中にエラーが発生しました。選択した文字コードが正しくない可能性があります。', 'error');
                geocodeButton.disabled = true;
                headerDisplay.classList.add('hidden'); // エラー時はヘッダー表示を隠す
            };
            reader.readAsText(file, encoding); // 選択された文字コードで読み込む
        });

        // ファイル選択クリアボタンイベントリスナー
        clearFileButton.addEventListener('click', () => {
            csvFileInput.value = ''; // ファイル選択をクリア
            parsedData = [];
            headers = [];
            resultData = [];
            addressColumnInput.value = ''; // 住所列名もクリア
            parsedHeadersText.textContent = ''; // 認識されたヘッダーをクリア
            headerDisplay.classList.add('hidden'); // ヘッダー表示を隠す
            showMessage('ファイルの選択がクリアされました。', 'info');
            geocodeButton.disabled = true; // クリアしたらジオコーディングボタンも無効化
            downloadCsvButton.disabled = true;
            cancelButton.classList.add('hidden'); // キャンセルボタンも非表示に
            progressBarContainer.classList.add('hidden'); // プログレスバーを隠す
            // 必須データが読み込まれている場合はジオコーディングボタンを再度有効にする
            if (stationsData.length > 0 || cityCodesData.length > 0) {
                geocodeButton.disabled = false;
                showMessage('ファイルの選択がクリアされました。新しいCSVファイルをアップロードしてください。');
            }
        });


        // CSVパース関数
        function parseCsv(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== ''); // 空行を除去
            if (lines.length === 0) {
                parsedData = [];
                headers = [];
                parsedHeadersText.textContent = ''; // ヘッダー表示をクリア
                headerDisplay.classList.add('hidden'); // ヘッダー表示を隠す
                throw new Error("CSVファイルが空またはデータがありません。");
            }
            // 区切り文字の自動判別（カンマ、セミコロン、タブ）
            let separator = ',';
            if (lines[0].includes(';')) {
                separator = ';';
            } else if (lines[0].includes('\t')) {
                separator = '\t';
            }

            headers = lines[0].split(separator).map(h => h.trim()); // ヘッダーをトリム
            parsedData = lines.slice(1).map(line => {
                const values = line.split(separator);
                const row = {};
                headers.forEach((header, i) => {
                    row[header] = values[i] ? values[i].trim() : ''; // 行のデータもトリム
                });
                return row;
            });

            // 認識されたヘッダーを表示
            parsedHeadersText.textContent = JSON.stringify(headers);
            headerDisplay.classList.remove('hidden');
        }

        /**
         * 住所の「1-2-3」のような表記を「1丁目2番3号」のように変換するヘルパー関数。
         *
         * @param {string} address - 元の住所文字列。
         * @returns {string} 変換された住所文字列。
         */
        function normalizeAddressHyphens(address) {
            let tempAddress = address;
            console.log(`normalizeAddressHyphens: Initial address: "${tempAddress}"`);

            // Rule 1: "数字丁目"の後の"数字-数字"パターンを"数字番数字号"に変換
            // 例: "西葛西3丁目15-12" -> "西葛西3丁目15番12号"
            // このルールを最優先することで、丁目以降の番地を正確に処理し、重複変換を防ぐ。
            tempAddress = tempAddress.replace(/(\d+丁目)(\d+)[-ー](\d+)(?![番号])/g, (match, p1, p2, p3) => {
                const result = `${p1}${p2}番${p3}号`;
                console.log(`normalizeAddressHyphens: Applied Rule 1 (丁目-番-号): "${match}" -> "${result}"`);
                return result;
            });
            console.log(`normalizeAddressHyphens: After Rule 1 (丁目-番-号): "${tempAddress}"`);


            // Rule 2: 一般的な"数字-数字-数字"パターンを"数字丁目数字番数字号"に変換
            // 例: "1-2-3" -> "1丁目2番3号"
            // 既に「丁目」「番」「号」が付いている部分には適用しない (ネガティブ後方参照)
            // Note: JavaScript regex does not natively support negative lookbehind for arbitrary length,
            // so we rely on explicit checks for preceding non-address characters.
            tempAddress = tempAddress.replace(/(?<![丁番号])(\d+)[-ー](\d+)[-ー](\d+)(?![丁番号])/g, (match, p1, p2, p3) => {
                const result = `${p1}丁目${p2}番${p3}号`;
                console.log(`normalizeAddressHyphens: Applied Rule 2 (general X-Y-Z): "${match}" -> "${result}"`);
                return result;
            });
            console.log(`normalizeAddressHyphens: After Rule 2 (general X-Y-Z): "${tempAddress}"`);


            // Rule 3: 一般的な"数字-数字"パターンを"数字番数字号"に変換
            // 例: "15-12" (丁目などが先行しない場合) -> "15番12号"
            // 既に「丁目」「番」「号」が付いている部分には適用しない (ネガティブ後方参照)
            tempAddress = tempAddress.replace(/(?<![丁番号])(\d+)[-ー](\d+)(?![丁番号])/g, (match, p1, p2) => {
                const result = `${p1}番${p2}号`;
                console.log(`normalizeAddressHyphens: Applied Rule 3 (general X-Y): "${match}" -> "${result}"`);
                return result;
            });
            console.log(`normalizeAddressHyphens: After Rule 3 (general X-Y): "${tempAddress}"`);
            
            // Rule 4: 最後に、数字の後に「号」がない場合に「号」を追加 (文末に限定)
            // 例: "1番2" -> "1番2号", "3丁目15番12" -> "3丁目15番12号"
            tempAddress = tempAddress.replace(/(\d+)(?![丁番号])$/, '$1号');
            console.log(`normalizeAddressHyphens: After Rule 4 (final 号): "${tempAddress}"`);

            return tempAddress;
        }

        /**
         * 全角ひらがな、全角カタカナを半角カタカナに変換する関数
         * @param {string} str - 変換する文字列
         * @returns {string} 半角カタカナに変換された文字列
         */
        function toHalfWidthKatakana(str) {
            if (!str) return '';
            let tempStr = str;

            // Step 1: Convert full-width Hiragana to full-width Katakana
            tempStr = tempStr.replace(/[\u3041-\u3096]/g, function(match) {
                return String.fromCharCode(match.charCodeAt(0) + 0x60);
            });

            // Step 2: Convert full-width Katakana to half-width Katakana
            return tempStr.replace(/[\u30a1-\u30f6]/g, function(match) {
                var chr = match.charCodeAt(0) - 0x60;
                return String.fromCharCode(chr);
            }).replace(/ヴ/g, 'ｳﾞ') // ヴ
              .replace(/ガ/g, 'ｶﾞ').replace(/ギ/g, 'ｷﾞ').replace(/グ/g, 'ｸﾞ').replace(/ゲ/g, 'ｹﾞ').replace(/ゴ/g, 'ｺﾞ')
              .replace(/ザ/g, 'ｻﾞ').replace(/ジ/g, 'ｼﾞ').replace(/ズ/g, 'ｽﾞ').replace(/ゼ/g, 'ｾﾞ').replace(/ゾ/g, 'ｿﾞ')
              .replace(/ダ/g, 'ﾀﾞ').replace(/ヂ/g, 'ﾁﾞ').replace(/ヅ/g, 'ﾂﾞ').replace(/デ/g, 'ﾃﾞ').replace(/ド/g, 'ﾄﾞ')
              .replace(/バ/g, 'ﾊﾞ').replace(/ビ/g, 'ﾋﾞ').replace(/ブ/g, 'ﾌﾞ').replace(/ベ/g, 'ﾍﾞ').replace(/ボ/g, 'ﾎﾞ')
              .replace(/パ/g, 'ﾊﾟ').replace(/ピ/g, 'ﾋﾟ').replace(/プ/g, 'ﾌﾟ').replace(/ペ/g, 'ﾍﾟ').replace(/ポ/g, 'ﾎﾟ')
              .replace(/ァ/g, 'ｧ').replace(/ィ/g, 'ｨ').replace(/ゥ/g, 'ｩ').replace(/ェ/g, 'ｪ').replace(/ォ/g, 'ｫ')
              .replace(/ャ/g, 'ｬ').replace(/ュ/g, 'ｭ').replace(/ョ/g, 'ｮ').replace(/ッ/g, 'ｯ') 
              .replace(/ー/g, 'ｰ'); // 長音符
        }

        /**
         * 住所文字列から郵便番号を抽出する関数。
         * @param {string} address - 住所文字列。
         * @returns {string} 抽出された7桁の郵便番号（ハイフンなし、ゼロ埋め）または空文字列。
         */
        function getPostalCodeFromAddress(address) {
            // 7桁の数字またはXXX-XXXX形式の郵便番号を検索
            const postcodeMatch = address.match(/(\d{3}[-]?\d{4})/);
            if (postcodeMatch && postcodeMatch[1]) {
                const postalCode = postcodeMatch[1].replace(/-/g, ''); // ハイフンを除去
                return postalCode.padStart(7, '0'); // 7桁にゼロ埋め
            }
            return ''; // 見つからなければ空文字列
        }

        // 都道府県名と市区町村名のみを抽出するヘルパー関数
        function getPrefCityWardForLookup(fullAddress) {
            let pref = '';
            let cityWard = '';

            // 都道府県を検出 (東京都, 北海道, 京都府, 大阪府, XX県)
            const prefRegex = /^(東京都|北海道|(?:京都|大阪)府|.{2,3}県)/;
            const prefMatch = fullAddress.match(prefRegex);
            if (prefMatch) {
                pref = prefMatch[0];
                let remainingAddress = fullAddress.substring(pref.length);

                // 市区町村を検出 (市, 区, 町, 村 で終わる)
                // より多くのパターンをカバーするため、区、郡、町、村を考慮
                const cityWardRegex = /^((?:.+?郡)?(?:.+?(?:市|区|町|村)))/; 
                const cityWardMatch = remainingAddress.match(cityWardRegex);

                if (cityWardMatch) {
                    cityWard = cityWardMatch[1]; 
                }
            }
            return { pref, city: cityWard };
        }

        // 市区町村コードを取得する関数
        function getCityCode(address) {
            if (cityCodesData.length === 0) {
                console.warn('市区町村コードデータが読み込まれていません。市区町村コードの取得機能は利用できません。');
                return 'データなし';
            }
            const { pref, city } = getPrefCityWardForLookup(address);
            if (!pref || !city) {
                console.warn(`住所から都道府県または市区町村を特定できませんでした: "${address}"`);
                return '不明';
            }

            console.log(`getCityCode: Searching for Pref: "${pref}", City: "${city}"`); // デバッグログ追加

            // 市区町村データからコードを検索
            const found = cityCodesData.find(item => {
                const itemPref = String(item['pref'] || '').trim(); // item['pref']がundefined/nullの場合も考慮してtrim
                const itemCity = String(item['city'] || '').trim(); // item['city']がundefined/nullの場合も考慮してtrim
                
                console.log(`getCityCode: Comparing input (Pref:"${pref}", City:"${city}") with master data entry (Pref:"${itemPref}", City:"${itemCity}", Code:"${item['code'] || 'N/A'}").`);
                const prefMatch = itemPref === pref;
                // 市区町村名のマッチングロジックを微調整
                // マスターデータ側の市区町村が空でない && (完全に一致 OR マスターデータ側の市区町村で始まる)
                const cityMatch = (itemCity && (itemCity === city || city.startsWith(itemCity))); 
                console.log(`getCityCode: Match condition results - Pref Match: ${prefMatch}, City Match: ${cityMatch}`);
                return prefMatch && cityMatch;
            });
            console.log(`getCityCode: Found item from master data:`, found); // 見つかったアイテムをログ出力

            if (found && found['code']) { 
                // 市区町村コードを5桁にゼロ埋め
                const paddedCode = String(found['code']).padStart(5, '0'); 
                console.log(`住所 "${address}" -> 検出都道府県: "${pref}", 市区町村: "${city}", コード: "${paddedCode}"`);
                return paddedCode;
            } else {
                console.warn(`住所 "${address}" (都道府県: "${pref}", 市区町村: "${city}") に対応する市区町村コードが見つかりません。`);
                return '不明';
            }
        }


        // 国土地理院のAPIで緯度経度を取得する関数
        async function getLatLonAndGSIAddressTitle(address) {
            if (!address) {
                return { latitude: '', longitude: '', gsiAddressTitle: '' };
            }

            const encodedAddress = encodeURIComponent(address);
            const apiUrl = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodedAddress}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                console.log(`住所 "${address}" の国土地理院APIレスポンス:`, data); // GSI APIレスポンスをログ出力

                if (!response.ok) {
                    console.error(`国土地理院APIリクエスト失敗: ${response.status} ${response.statusText} for address: ${address}`);
                    return { latitude: 'エラー', longitude: 'エラー', gsiAddressTitle: 'エラー' };
                }

                if (data && data.length > 0 && data[0].geometry && data[0].geometry.coordinates) {
                    const longitude = data[0].geometry.coordinates[0];
                    const latitude = data[0].geometry.coordinates[1];
                    const gsiAddressTitle = data[0].properties ? data[0].properties.title : ''; // 国交省住所1用
                    return { latitude, longitude, gsiAddressTitle };
                } else {
                    console.warn(`住所 "${address}" の緯度経度または国交省住所が見つかりませんでした（APIレスポンスデータ不足）。`);
                    return { latitude: '見つかりません', longitude: '見つかりません', gsiAddressTitle: '見つかりません' };
                }
            } catch (error) {
                console.error(`住所 "${address}" の国土地理院APIからの緯度経度・コード取得中にエラーが発生しました:`, error);
                return { latitude: 'エラー', longitude: 'エラー', gsiAddressTitle: 'エラー' };
            }
        }

        // 駅データを外部から読み込む関数 (GeoJSON対応)
        async function loadStationsData() {
            showMessage('駅データを読み込み中...', 'info');
            try {
                const response = await fetch(stationsDataUrl);
                if (!response.ok) {
                    const errorText = await response.text(); // レスポンスボディを取得してより詳細な情報
                    console.error('Fetch response not OK:', response.status, response.statusText, 'Body:', errorText);
                    throw new Error(`ネットワークエラー: ${response.status} ${response.statusText}. URLまたはネットワーク接続を確認してください。`);
                }
                
                let geoJson;
                try {
                    geoJson = await response.json(); // GeoJSONとしてパース
                    console.log('GeoJSONを正常にパースしました:', geoJson); 
                } catch (jsonError) {
                    console.error('GeoJSONのパース中にエラー:', jsonError);
                    throw new Error(`GeoJSONファイル形式が不正です。ファイルが破損しているか、有効なGeoJSON形式ではありません。`);
                }

                if (geoJson && geoJson.features && geoJson.features.length > 0) { // features配列が存在し、かつ空でないことを確認
                    let tempStations = geoJson.features.map(feature => {
                        let longitude = null;
                        let latitude = null;

                        // GeoJSONのgeometryタイプに応じて座標を抽出
                        if (feature.geometry && feature.geometry.coordinates) {
                            if (feature.geometry.type === "Point") {
                                longitude = feature.geometry.coordinates[0];
                                latitude = feature.geometry.coordinates[1];
                            } else if (feature.geometry.type === "LineString") {
                                // LineStringの場合、最初の点の座標を使用
                                if (feature.geometry.coordinates.length > 0) {
                                    longitude = feature.geometry.coordinates[0][0];
                                    latitude = feature.geometry.coordinates[0][1];
                                }
                            } else if (feature.geometry.type === "MultiLineString") {
                                // MultiLineStringの場合、最初の線分の最初の点の座標を使用
                                if (feature.geometry.coordinates.length > 0 && feature.geometry.coordinates[0].length > 0) {
                                    longitude = feature.geometry.coordina
